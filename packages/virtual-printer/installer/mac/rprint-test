#!/bin/bash
#
# RPrint Comprehensive Test Script
# Tests all aspects of the RPrint virtual printer installation
#

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

TESTS_PASSED=0
TESTS_FAILED=0

print_header() {
    echo ""
    echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
    echo ""
}

test_pass() {
    echo -e "${GREEN}✓ PASS${NC}: $1"
    ((TESTS_PASSED++))
}

test_fail() {
    echo -e "${RED}✗ FAIL${NC}: $1"
    echo -e "${YELLOW}  → $2${NC}"
    ((TESTS_FAILED++))
}

test_warn() {
    echo -e "${YELLOW}⚠ WARN${NC}: $1"
}

print_header "RPrint Virtual Printer - Comprehensive Test"

echo "Testing RPrint installation and configuration..."
echo ""

# Test 1: Backend exists
print_header "Test 1: Backend Installation"
if [ -f "/usr/libexec/cups/backend/rprint" ]; then
    test_pass "Backend file exists at /usr/libexec/cups/backend/rprint"

    # Check permissions
    PERMS=$(stat -f "%Lp" /usr/libexec/cups/backend/rprint)
    if [ "$PERMS" = "755" ]; then
        test_pass "Backend has correct permissions (755)"
    else
        test_fail "Backend permissions incorrect" "Expected 755, got $PERMS"
    fi

    # Check if it's executable
    if [ -x "/usr/libexec/cups/backend/rprint" ]; then
        test_pass "Backend is executable"
    else
        test_fail "Backend is not executable" "Run: sudo chmod 755 /usr/libexec/cups/backend/rprint"
    fi
else
    test_fail "Backend file not found" "Run the installer: sudo ./install.sh"
fi

# Test 2: Backend discovery
print_header "Test 2: Backend Discovery"
BACKEND_OUTPUT=$(/usr/libexec/cups/backend/rprint 2>&1)
if echo "$BACKEND_OUTPUT" | grep -q "file rprint"; then
    test_pass "Backend responds to discovery request"
    echo "  Output: $BACKEND_OUTPUT"
else
    test_fail "Backend discovery failed" "Output: $BACKEND_OUTPUT"
fi

# Test 3: Printer exists
print_header "Test 3: Printer Configuration"
if lpstat -p RPrint >/dev/null 2>&1; then
    test_pass "RPrint printer is configured"

    # Check printer status
    STATUS=$(lpstat -p RPrint | grep -o "idle\|disabled\|processing")
    if echo "$STATUS" | grep -q "idle"; then
        test_pass "Printer is idle and ready"
    elif echo "$STATUS" | grep -q "processing"; then
        test_warn "Printer is currently processing a job"
    else
        test_fail "Printer is disabled" "Run: sudo cupsenable RPrint && sudo cupsaccept RPrint"
    fi

    # Check device URI
    DEVICE_URI=$(lpstat -v RPrint | awk '{print $NF}')
    if [ "$DEVICE_URI" = "rprint:/" ]; then
        test_pass "Printer has correct device URI (rprint:/)"
    else
        test_warn "Unexpected device URI: $DEVICE_URI"
    fi
else
    test_fail "RPrint printer not found" "Run the installer: sudo ./install.sh"
fi

# Test 4: Backend credentials
print_header "Test 4: Backend Credentials"
BACKEND_FILE="/usr/libexec/cups/backend/rprint"
if grep -q "RPRINT_SERVER_URL=" "$BACKEND_FILE"; then
    SERVER_URL=$(grep "^RPRINT_SERVER_URL=" "$BACKEND_FILE" | cut -d'"' -f2)
    test_pass "Server URL configured: $SERVER_URL"
else
    test_fail "Server URL not found in backend" "Backend may be corrupted"
fi

if grep -q "RPRINT_AUTH_TOKEN=" "$BACKEND_FILE"; then
    TOKEN_LENGTH=$(grep "^RPRINT_AUTH_TOKEN=" "$BACKEND_FILE" | cut -d'"' -f2 | wc -c)
    test_pass "Auth token configured (length: $TOKEN_LENGTH)"
else
    test_fail "Auth token not found in backend" "Backend may be corrupted"
fi

if grep -q "RPRINT_DEFAULT_PRINTER_ID=" "$BACKEND_FILE"; then
    PRINTER_ID=$(grep "^RPRINT_DEFAULT_PRINTER_ID=" "$BACKEND_FILE" | cut -d'"' -f2)
    test_pass "Printer ID configured: $PRINTER_ID"
else
    test_fail "Printer ID not found in backend" "Backend may be corrupted"
fi

# Test 5: Network connectivity
print_header "Test 5: Network Connectivity"
if curl -s --max-time 5 -I https://growingsoft.net >/dev/null 2>&1; then
    test_pass "Can reach RPrint server (https://growingsoft.net)"
else
    test_fail "Cannot reach RPrint server" "Check your internet connection"
fi

# Test 6: Backend execution test
print_header "Test 6: Backend Execution Test"
echo "Test content for RPrint" > /tmp/rprint-test-file.txt
if [ -f /tmp/rprint-test-file.txt ]; then
    echo "Running backend with test file..."
    BACKEND_OUTPUT=$(sudo /usr/libexec/cups/backend/rprint 999 testuser "Test Job" 1 "" /tmp/rprint-test-file.txt 2>&1)

    if echo "$BACKEND_OUTPUT" | grep -q "Print job uploaded successfully"; then
        test_pass "Backend successfully uploaded test file"
        echo "$BACKEND_OUTPUT" | grep "INFO:" | sed 's/^/  /'
    elif echo "$BACKEND_OUTPUT" | grep -q "HTTP Status: 401"; then
        test_fail "Authentication failed" "Token may be expired or invalid"
        echo "$BACKEND_OUTPUT" | sed 's/^/  /'
    elif echo "$BACKEND_OUTPUT" | grep -q "HTTP Status:"; then
        test_fail "Server returned error" "Check backend output below"
        echo "$BACKEND_OUTPUT" | sed 's/^/  /'
    else
        test_fail "Backend execution failed" "See output below"
        echo "$BACKEND_OUTPUT" | sed 's/^/  /'
    fi

    rm -f /tmp/rprint-test-file.txt
else
    test_fail "Could not create test file" "Check /tmp directory permissions"
fi

# Test 7: CUPS error log
print_header "Test 7: Recent CUPS Errors"
if [ -f /var/log/cups/error_log ]; then
    RECENT_ERRORS=$(sudo tail -20 /var/log/cups/error_log | grep "RPrint\|rprint" | grep "ERROR" | tail -5)
    if [ -z "$RECENT_ERRORS" ]; then
        test_pass "No recent errors in CUPS log"
    else
        test_warn "Recent errors found in CUPS log:"
        echo "$RECENT_ERRORS" | sed 's/^/  /'
    fi
else
    test_warn "CUPS error log not accessible"
fi

# Summary
print_header "Test Summary"
TOTAL_TESTS=$((TESTS_PASSED + TESTS_FAILED))
echo -e "Total Tests: $TOTAL_TESTS"
echo -e "${GREEN}Passed: $TESTS_PASSED${NC}"
echo -e "${RED}Failed: $TESTS_FAILED${NC}"
echo ""

if [ $TESTS_FAILED -eq 0 ]; then
    echo -e "${GREEN}╔═══════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║  ALL TESTS PASSED! ✓                                 ║${NC}"
    echo -e "${GREEN}║  RPrint is ready to use!                             ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo "To print a test page:"
    echo "  echo 'Hello from RPrint' | lp -d RPrint"
    echo ""
    exit 0
else
    echo -e "${RED}╔═══════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║  SOME TESTS FAILED                                    ║${NC}"
    echo -e "${RED}╚═══════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo "Please fix the issues above and run 'rprint-test' again."
    echo ""
    exit 1
fi
